---
title: NSIS Malware

---

# NSIS Malware

![image](https://hackmd.io/_uploads/ryx5BayI-e.png)

B√†i n√†y n√™n l√†m ·ªü VM nh√© m·ªçi ng∆∞·ªùi

Nh√¨n qua th√¨ b√†i ch·ªâ hint ·ªü t√™n ƒë·ªÅ l√† NSIS Malware, NSIS l√† 1 c√¥ng c·ª• t·∫°o installer cho Windows, d√πng script `.nsi`. Ta n√™n t·∫≠p trung v√†o NSIS ƒë·ªÉ gi·∫£i.

ƒê·ªçc qua profile t√≠
![image](https://hackmd.io/_uploads/rkG-_aJLZl.png)

ƒê·ªëi v·ªõi file NSIS n√†y, ta s·∫Ω extract n√≥ ra ƒë·ªÉ xem b√™n trong ch·ª©a c√°c file th·ª±c thi g√¨, ƒë·ªìng th·ªùi ƒë·ªçc lu√¥n script c·ªßa n√≥

![image](https://hackmd.io/_uploads/rk-Bu6kUWe.png)

Do d√πng VM n√™n m√¨nh s·∫Ω ch·∫°y th·ª≠ file installer xem th·∫ø n√†o
![image](https://hackmd.io/_uploads/rknysaJU-g.png)
![image](https://hackmd.io/_uploads/r1uWsak8Zx.png)

N√≥ s·∫Ω b·∫Øt ƒë·∫ßu ch∆∞∆°ng tr√¨nh v√† trong qu√° t√¨nh installing th√¨ s·∫Ω c√≥ 1 ƒëo·∫°n checker. Sai th√¨ in ra Wrong, ƒë√∫ng th√¨ m√¨nh ch∆∞a r√µ. 

Ch√∫ng ta s·∫Ω ƒë·ªçc file `.nsi` tr∆∞·ªõc : 
<details> 
    <summary><b>Code [NSIS].nsi</b></summary>
    ; NSIS script (UTF-8) NSIS-3 Unicode
; Install

Unicode true
SetCompressor zlib

; --------------------
; HEADER SIZE: 14146
; START HEADER SIZE: 300
; MAX STRING LENGTH: 1024
; STRING CHARS: 1602

OutFile [NSIS].exe
!include WinMessages.nsh



; --------------------
; LANG TABLES: 1
; LANG STRINGS: 55

Name AvocadoApp
BrandingText "Nullsoft Install System v3.11"

; LANG: 1033
LangString LSTR_0 1033 "Nullsoft Install System v3.11"
LangString LSTR_1 1033 "$(LSTR_2) Setup"
LangString LSTR_2 1033 AvocadoApp
LangString LSTR_3 1033 "Space available: "
LangString LSTR_4 1033 "Space required: "
LangString LSTR_5 1033 "Can't write: "
LangString LSTR_13 1033 "Delete file: "
LangString LSTR_14 1033 "Delete on reboot: "
LangString LSTR_17 1033 "Error decompressing data! Corrupted installer?"
LangString LSTR_20 1033 "Execute: "
LangString LSTR_21 1033 "Extract: "
LangString LSTR_22 1033 "Extract: error writing to file "
LangString LSTR_23 1033 "Installer corrupted: invalid opcode"
LangString LSTR_25 1033 "Output folder: "
LangString LSTR_26 1033 "Remove folder: "
LangString LSTR_29 1033 "Skipped: "
LangString LSTR_30 1033 "Copy Details To Clipboard"
LangString LSTR_32 1033 B
LangString LSTR_33 1033 " K"
LangString LSTR_34 1033 " M"
LangString LSTR_35 1033 " G"
LangString LSTR_36 1033 "Error opening file for writing: $\r$\n$\r$\n$0$\r$\n$\r$\nClick Abort to stop the installation,$\r$\nRetry to try again, or$\r$\nIgnore to skip this file."
LangString LSTR_37 1033 Custom
LangString LSTR_38 1033 Cancel
LangString LSTR_39 1033 ": Installation Folder"
LangString LSTR_40 1033 "Setup will install $(LSTR_54) in the following folder. To install in a different folder, click Browse and select another folder. $_CLICK"
LangString LSTR_41 1033 "Destination Folder"
LangString LSTR_42 1033 B&rowse...
LangString LSTR_43 1033 "Select the folder to install $(LSTR_54) in:"
LangString LSTR_44 1033 "< &Back"
LangString LSTR_45 1033 &Install
LangString LSTR_46 1033 "Click Install to start the installation."
LangString LSTR_47 1033 ": Installing"
LangString LSTR_48 1033 "Show &details"
LangString LSTR_49 1033 Completed
LangString LSTR_50 1033 "&Next >"
LangString LSTR_51 1033 "Click Next to continue."
LangString LSTR_52 1033 ": Completed"
LangString LSTR_53 1033 &Close
LangString LSTR_54 1033 AvocadoApp


; --------------------
; VARIABLES: 19

Var _0_
Var _1_
Var _2_
Var _3_
Var _4_
Var _5_
Var _6_
Var _7_
Var _8_
Var _9_
Var _10_
Var _11_
Var _12_
Var _13_
Var _14_
Var _15_
Var _16_
Var _17_
Var _18_


InstType $(LSTR_37)    ;  Custom
InstallDir $PROGRAMFILES\AvocadoApp
; install_directory_auto_append = AvocadoApp
; wininit = $WINDIR\wininit.ini


; --------------------
; PAGES: 3

; Page 0
Page directory /ENABLECANCEL
  DirText $(LSTR_40) $(LSTR_41) $(LSTR_42) $(LSTR_43)    ;  "Setup will install $(LSTR_54) in the following folder. To install in a different folder, click Browse and select another folder. $_CLICK" "Destination Folder" B&rowse... "Select the folder to install $(LSTR_54) in:" AvocadoApp AvocadoApp
  DirVar $CMDLINE

; Page 1
Page instfiles
  CompletedText $(LSTR_49)    ;  Completed
  DetailsButtonText $(LSTR_48)    ;  "Show &details"

/*
; Page 2
Page COMPLETED
*/


; --------------------
; SECTIONS: 2
; COMMANDS: 217

  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
  Invalid
Function .onInit
  StrCpy $_12_ init
  StrCpy $_13_ loading
  StrCpy $_14_ 0
  IntOp $_15_ 0 + 1
FunctionEnd


Function func_108
  Sleep 50
  StrCpy $_16_ asvasdsacs
FunctionEnd


Function func_111
  Sleep 30
  IntOp $_15_ $_15_ + 1
FunctionEnd


Function func_114
  StrCpy $_17_ $TEMP
  Sleep 25
FunctionEnd


Function func_117
  Push $0
  Push $1
  Push $2
  StrCpy $0 c
  StrCpy $1 m
  StrCpy $2 d
  StrCpy $_18_ "$0$1$2.exe /C "
  Call func_108
  StrCpy $_18_ "$_18_$\"cd /d $\"$INSTDIR$\" && $\""
  StrCpy $0 r
  StrCpy $1 a
  StrCpy $2 k
  StrCpy $R1 e
  StrCpy $_18_ "$_18_$0$1$2$R1.exe$\" "
  StrCpy $0 ex
  StrCpy $1 tr
  StrCpy $2 act
  StrCpy $_18_ "$_18_$0$1$2 "
  Call func_111
  StrCpy $0 av
  StrCpy $1 oc
  StrCpy $2 ad
  StrCpy $R1 o
  StrCpy $_18_ $_18_$0$1$2$R1.exe
  StrCpy $0 " && time"
  StrCpy $1 "out /t 3"
  StrCpy $2 " /nobreak >nul"
  StrCpy $_18_ $_18_$0$1$2$\"
  Call func_114
  Pop $2
  Pop $1
  Pop $0
FunctionEnd


Section Install ; Section_0
  ; AddSize 26941
  Call func_108
  StrCmp $_14_ 0 0 label_154
  StrCpy $_14_ 1
  Call func_111
label_154:
  RMDir /r $INSTDIR
  Call func_114
  SetOutPath $INSTDIR
  IntOp $_15_ $_15_ * 2
  StrCpy $_OUTDIR $OUTDIR
  File apple.exe
  File avocado.exe
  File cherry.exe
  File mix.exe
  File peach.exe
  File pear.exe
  SetOutPath $_OUTDIR
  StrCpy $_16_ files_copied
  File hoe.exe
  File installer.exe
  File plow.exe
  File rake.exe
  File sickle.exe
  StrCpy $_12_ install_done
SectionEnd


Section ; Section_1
  StrCmp $_12_ install_done 0 label_176
  StrCpy $_13_ post_init
label_176:
  Call func_108
  SetOutPath $INSTDIR
  Sleep 100
  Call func_111
  Call func_117
  Call func_114
  StrCmp $_13_ post_init 0 label_184
  StrCpy $_17_ $INSTDIR
label_184:
  StrCpy $0 Pro
  StrCpy $1 cess
  StrCpy $2 ing...
  DetailPrint $0$1$2
  Call func_114
  SetDetailsPrint none
  ExecWait $_18_ $R0
  Sleep 200
  Call func_108
  IntOp $_15_ $_15_ / 2
  StrCpy $_18_ ""
  StrCpy $1 0
  IntCmp $_15_ 0 label_198 label_198
  StrCpy $_14_ delete_start
label_198:
  Sleep 50
  RMDir /r $INSTDIR
  IfFileExists $INSTDIR\*.* 0 label_208
  IntCmp $1 5 label_208 label_202 label_202
label_202:
  Call func_111
  IntOp $1 $1 + 1
  Sleep 500
  IntCmp $1 3 label_207 0 label_207
  StrCpy $_12_ retry_$1
label_207:
  Goto label_198
label_208:
  StrCpy $2 Oper
  StrCpy $3 "ation "
  StrCpy $4 "exit "
  StrCpy $5 "code: "
  DetailPrint $2$3$4$5$R0
  StrCpy $_16_ ""
  StrCpy $_17_ ""
  StrCpy $_14_ completed
SectionEnd



; --------------------
; UNREFERENCED STRINGS:

/*
17 CommonFilesDir
49 $PROGRAMFILES
52 "$PROGRAMFILES\Common Files"
68 $COMMONFILES
94 $3
97 $4
104 63
107 $1c
111 6D
114 $1m
118 64
121 $1d
125 2E
128 $1.
132 65
135 $1e
139 78
142 $1x
146 20
149 "$1 "
153 2F
156 $1/
160 43
163 $1C
167 22
170 $1$\"
174 26
177 $1&
181 72
184 $1r
188 61
191 $1a
195 6B
198 $1k
202 74
205 $1t
209 69
212 $1i
216 6E
219 $1n
223 6F
226 $1o
230 75
233 $1u
237 33
240 +
242 6C
245 $1l
249 76
252 $1v
256 3E
259 $1>
263 62
266 $1b
270 73
273 $1s
277 68
280 $1h
284 $1?
*/

</details>

ƒê·ªçc qua 1 h·ªìi, ch√∫ng ta s·∫Ω nh·∫≠n ra script n√†y ban ƒë·∫ßu s·∫Ω g√°n c√°c n·ªôi dung string v√†o c√°c bi·∫øn ƒë∆°n l·∫ª, sau ƒë√≥ t·ªõi `func_117` s·∫Ω gh√©p c√°c bi·∫øn ƒë∆°n l·∫ª ƒë√≥ l·∫°i th√†nh 1 l·ªánh ho√†n ch·ªânh, l∆∞u t·∫°i bi·∫øn `$_18_`. 

Sau ƒë√≥ ch·∫°y 1 l·ªánh  : `ExecWait $_18_ $R0`

L·ªánh th·ª±c t·∫ø m√† `$_18_` ch·ª©a : `cmd.exe /C "cd /d "%INSTDIR%" && rake.exe extract avocado.exe && timeout /t 3 /nobreak >nul"`

Cu·ªëi c√πng ch·∫°y `RMDir /r $INSTDIR` ƒë·ªÉ xo√° to√†n b·ªô file v·ª´a drop ra


Ta s·∫Ω test l·ªánh sau : `rake.exe extract avocado.exe`
```bash=
C:\Users\hieesu19\Documents\CTF\ILoveFruit>rake.exe extract avocado.exe
Enter flag: chotaoflag
wrong
```

M·ªü ProcMon l√™n trace, ƒë·ªìng th·ªùi ch·∫°y l·ªánh `rake.exe extract avocado.exe` nh∆∞ng c·ª© treo, kh√¥ng ghi input . 1 Tip n·∫øu g·∫∑p c√°c file n√≥ xo√° lu√¥n, kh√¥ng ƒë·ª£i nh·∫≠p input l√† ta s·∫Ω d√πng ProcMon, pause l·∫°i ƒë·ªÉ Capture.
![image](https://hackmd.io/_uploads/rkI9zA1IZg.png)

M√¨nh filter b·∫±ng Operation l√† CreateFile v√† WriteFile v√¨ bi·∫øt r·∫±ng n√≥ t·∫°o ra 1 file n√†o ƒë√≥ 

B·∫°n s·∫Ω th·∫•y r·∫±ng ho·∫°t log g·∫ßn nh·∫•t l√† n√≥ ƒëang t·∫°o file `shc1A77.tmp` ·ªü th∆∞ m·ª•c `TEMP`, v√† ƒë·ªçc th√¨ tr√¥ng n√≥ sus nh·∫•t n√™n m√¨nh s·∫Ω v√†o folder `TEMP` ƒë·ªÉ copy n√≥ ra

Xem qua profile
```bash
C:\Users\hieesu19\Documents\CTF>file shc1A77.tmp
    shc1A77.tmp: PE32 executable (console) Intel 80386, for MS Windows
```

V·∫≠y l√† kh√° ch·∫Øc n√≥ l√† file th·ª±c thi ch√≠nh m√† ta c·∫ßn ph√¢n t√≠ch. V·ª©t lu√¥n v√†o IDA
```c
// attributes: thunk
int start()
{
  return start_0();
}
```
Tr√¥ng h∆°i l·ªè nh·ªâ, decompiler kh√¥ng nh·∫≠n ra ƒë∆∞·ª£c h√†m main x·ª≠ l√Ω ch√≠nh do nhi·ªÅu l√Ω do, cho n√™n ta c·∫ßn trace ƒë·ªÉ xem h√†m n√†o nh·∫≠n Argc hay Argv l√†m tham s·ªë th√¨ kh·∫£ nƒÉng cao n√≥ s·∫Ω l√† h√†m main

```c
int sub_2852C0()
{
  int *v0; // eax
  wchar_t **v2; // [esp+4h] [ebp-8h]
  wchar_t **initial_wide_environment; // [esp+8h] [ebp-4h]

  initial_wide_environment = j__get_initial_wide_environment();
  v2 = *j___p___wargv();
  v0 = j___p___argc();
  return sub_2714F6(*v0, v2, initial_wide_environment);
}

// attributes: thunk
int __cdecl sub_2714F6(int a1, int a2, int initial_wide_environment)
{
  return sub_283CF0(a1, a2, initial_wide_environment);
}

int __cdecl main(int argc, const char **argv, const char **envp)
{
  __int16 *p_Buf1_1; // edx
  int v4; // eax
  char v6; // [esp-1Ch] [ebp-1FCh] BYREF
  int v7; // [esp-18h] [ebp-1F8h]
  int v8; // [esp-14h] [ebp-1F4h]
  char v9; // [esp-10h] [ebp-1F0h] BYREF
  int v10; // [esp-Ch] [ebp-1ECh]
  int v11; // [esp-8h] [ebp-1E8h]
  __int16 *p_Buf1; // [esp-4h] [ebp-1E4h]
  wchar_t *correct_n; // [esp+10h] [ebp-1D0h]
  int v14; // [esp+18h] [ebp-1C8h]
  char *v15; // [esp+24h] [ebp-1BCh]
  char *v16; // [esp+30h] [ebp-1B0h]
  __int16 v17; // [esp+3Eh] [ebp-1A2h] BYREF
  int v18; // [esp+48h] [ebp-198h]
  char *v19; // [esp+54h] [ebp-18Ch]
  char *v20; // [esp+60h] [ebp-180h]
  __int16 Buf1; // [esp+6Eh] [ebp-172h] BYREF
  _BYTE v23[36]; // [esp+144h] [ebp-9Ch] BYREF
  _BYTE v24[36]; // [esp+168h] [ebp-78h] BYREF
  _BYTE v25[24]; // [esp+18Ch] [ebp-54h] BYREF
  _BYTE v26[24]; // [esp+1A4h] [ebp-3Ch] BYREF
  _BYTE v27[20]; // [esp+1BCh] [ebp-24h] BYREF
  int n2; // [esp+1DCh] [ebp-4h]
  int savedregs; // [esp+1E0h] [ebp+0h] BYREF

  sub_271B27(&unk_29310F);
  if ( (unsigned __int8)sub_27BBB0() || (unsigned __int8)sub_27BC40() || (unsigned __int8)sub_27BD50() )
  {
    sub_271744(0x10u);
    sub_271311(v27);
    n2 = 0;
    sub_27BAF0(v27);
  }
  if ( !(unsigned __int8)sub_281E70() )
  {
    sub_271744(0x10u);
    sub_271311(v26);
    n2 = 1;
    sub_27BAF0(v26);
  }
  sub_271744(0x10u);
  sub_271311(v25);
  n2 = 2;
  sub_280960((unsigned int)v24, (int)v25);
  LOBYTE(n2) = 3;
  sub_271712(std::wcout, (wchar_t *)L"Enter flag: ");
  sub_271631(v23);
  LOBYTE(n2) = 4;
  sub_271375(std::wcin, v23);
  if ( (unsigned __int8)sub_2717F8(v23) )
  {
    sub_271712(std::wcout, (wchar_t *)L"wrong\n");
    Buf1 = 0;
    p_Buf1 = &Buf1;
    v20 = &v9;
    sub_27106E(&v9);
    v19 = &v6;
    sub_27116D(&v6);
    sub_2719B5(v6, v7, v8, v9, v10, v11, p_Buf1);
    v18 = 0;
    LOBYTE(n2) = 3;
    sub_2719F1(v23);
    LOBYTE(n2) = 2;
    sub_2719F1(v24);
    n2 = -1;
    sub_271D1B(v25);
    v4 = v18;
  }
  else
  {
    if ( sub_281040((int)v24, (int)v23) )
      correct_n = L"correct\n";
    else
      correct_n = (wchar_t *)L"wrong\n";
    sub_271712(std::wcout, correct_n);
    v17 = 0;
    p_Buf1 = &v17;
    v16 = &v9;
    sub_27106E(&v9);
    v15 = &v6;
    sub_27116D(&v6);
    sub_2719B5(v6, v7, v8, v9, v10, v11, p_Buf1);
    v14 = 0;
    LOBYTE(n2) = 3;
    sub_2719F1(v23);
    LOBYTE(n2) = 2;
    sub_2719F1(v24);
    n2 = -1;
    sub_271D1B(v25);
    v4 = v14;
  }
  p_Buf1 = p_Buf1_1;
  v11 = v4;
  sub_2716A4(&savedregs, &dword_283FE4);
  return v11;
}    
```
ok v·∫≠y l√† h√†m `sub_283CF0` l√† main, m√¨nh s·∫Ω rename l·∫°i cho d·ªÖ nh√¨nn


Nh√¨n qua th√¨ `sub_2717F8` s·∫Ω c√≥ v·∫ª check xem input c√≥ b·ªã r·ªóng hay sai ƒë·ªãnh d·∫°ng hay kh√¥ng, sai ghi wrong. C√≥ th·ªÉ ƒë·∫∑t BP ƒë·ªÉ trace. 
    
Ti·∫øp theo `sub_281040` s·∫Ω check g√¨ ƒë√≥, n·∫øu m√† ƒë√∫ng th√¨ in Correct, sai th√¨ Wrong. v√† h√†m nh·∫≠n tham s·ªë l√† v24 v√† v23
    
M√¨nh trace ng∆∞·ª£c l√™n xem 2 bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c set nh∆∞ n√†o, th√¨ nh·∫≠n th·∫•y v23 l√† input, c√≤n v24 s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω t·∫°i h√†m `sub_280960`, m√† h√†m n√†y th√¨ nh·∫≠n v24 v√† v25 l√†m tham s·ªë. V√† v25 ƒë∆∞·ª£c x·ª≠ l√Ω b·∫±ng h√†m `sub_271311`. ƒê·∫øn ƒë√¢y th√¨ h·∫øt h√†m li√™n quan r·ªìi, m√¨nh s·∫Ω t·∫°m th·ªùi ƒëi theo h∆∞·ªõng trace c√°c h√†m n√†y xem n√≥ l√†m c√°i g√¨. 


### **SOLVE**

- Do ƒë√£ b·ªã binary stripped n√™n pseudocode tr√¥ng kh√° nh·ª©c m·∫Øt, m√¨nh s·∫Ω debug ƒë·ªÉ xem gi√° tr·ªã tr∆∞·ªõc v√† sau c·ªßa c√°c bi·∫øn, l∆∞u √Ω l√† b√†i c√≥ s·ª≠ d·ª•ng c√°c k·ªπ thu·∫≠t anti-debug n√™n c·∫ßn bypass 1 ch√∫t
- B·∫Øt ƒë·∫ßu v·ªõi h√†m `sub_271311` ,khi trace v√† data c·ªßa `v25` tr∆∞·ªõc v√† sau khi h√†m th·ª±c thi th√¨ m√¨nh k·∫øt lu·∫≠n ƒë√≥ l√† v25 l√† 1 std::vector<byte> (1 ph·∫ßn t·ª≠ = 1 byte, m√¨nh ch∆∞a r√µ n√≥ c·ª• th·ªÉ l√† d·∫°ng n√†o). V√† h√†m `sub_271311` l√† h√†m kh·ªüi t·∫°o object cho bi·∫øn v25. 
- H√†m `sub_280960(v24, v25)` c√≥ v·∫ª l√† h√†m x·ª≠ l√Ω ch√≠nh, khi m√† m√¨nh ph√¢n t√≠ch tƒ©nh th√¨ th·∫•y kh√° ph·ª©c t·∫°p, sau khi debug th√¨ cho ra k·∫øt qu·∫£ r·∫•t ngon :))) . 
- tr∆∞·ªõc ƒë√≥, v24 l√† 1 buffer ch·ª©a 32bytes r√°c, sau khi call `sub_280960(v24, v25)` th√¨ m√¨nh th·∫•y v25 c√≥ thay ƒë·ªïi ch√∫t,  c√≤n v24 th√¨ nh∆∞ n√†y
```assembly
Stack[00001B68]:012FF7D4 db 68h
Stack[00001B68]:012FF7D5 db 0E5h
Stack[00001B68]:012FF7D6 db  44h ; D
Stack[00001B68]:012FF7D7 db    1
Stack[00001B68]:012FF7D8 db 0E8h
Stack[00001B68]:012FF7D9 db  3Dh ; =
Stack[00001B68]:012FF7DA db  45h ; E
Stack[00001B68]:012FF7DB db    1
Stack[00001B68]:012FF7DC db    0
Stack[00001B68]:012FF7DD db    0
Stack[00001B68]:012FF7DE db    0
Stack[00001B68]:012FF7DF db    0
Stack[00001B68]:012FF7E0 db    0
Stack[00001B68]:012FF7E1 db    0
Stack[00001B68]:012FF7E2 db    0
Stack[00001B68]:012FF7E3 db    0
Stack[00001B68]:012FF7E4 db 0
Stack[00001B68]:012FF7E5 db    0
Stack[00001B68]:012FF7E6 db    0
Stack[00001B68]:012FF7E7 db    0
Stack[00001B68]:012FF7E8 db  24h ; $
Stack[00001B68]:012FF7E9 db    0
Stack[00001B68]:012FF7EA db    0
Stack[00001B68]:012FF7EB db    0
Stack[00001B68]:012FF7EC db  27h ; '
Stack[00001B68]:012FF7ED db    0
Stack[00001B68]:012FF7EE db    0
Stack[00001B68]:012FF7EF db    0
Stack[00001B68]:012FF7F0 db 0CCh
Stack[00001B68]:012FF7F1 db 0CCh
Stack[00001B68]:012FF7F2 db 0CCh
Stack[00001B68]:012FF7F3 db 0CCh
Stack[00001B68]:012FF7F4 db 0CCh
Stack[00001B68]:012FF7F5 db 0CCh
Stack[00001B68]:012FF7F6 db 0CCh
Stack[00001B68]:012FF7F7 db 0CCh
```
    
Tr√¥ng kh√° gi·ªëng 1 object ƒë√∫ng kh√¥ng, do ki·∫øn tr√∫c 32bit n√™n m√¨nh gh√©p 4bytes 1 l·∫°i l√†m 1 ƒë·ªãa ch·ªâ xem n√≥ c√≥ ph·∫£i con tr·ªè d·∫´n ƒë·∫øn ƒë√¢u kh√¥ng, th√¨ wow : 
```bash
Stack[00001B68]:012FF7D4 dd offset unk_144E568
Stack[00001B68]:012FF7D8 dd offset aDh9cee017d4543       ; "DH{9cee017d454391a097fb55cc4dd4eee7}"
Stack[00001B68]:012FF7DC db    0
Stack[00001B68]:012FF7DD db    0
Stack[00001B68]:012FF7DE db    0
Stack[00001B68]:012FF7DF db    0
Stack[00001B68]:012FF7E0 db    0
Stack[00001B68]:012FF7E1 db    0
```
Ra lu√¥n flag m·ªõi √°c, m√¨nh test th√¨ n√≥ submit ƒë∆∞·ª£c r·ªìi =))
ƒê√°ng l·∫Ω ƒë·∫øn ƒë√¢y th√¨ m√¨nh c≈©ng th√¥i, nh∆∞ng l·ª° r·ªìi th√¨ ph√¢n t√≠ch s√¢u lu·ªìng c·ªßa b√†i n√†y lu√¥n

T·ª´ vi·ªác trace h√†m `sub_280960(v24, v25)` th√¨ h√†m n√†y l√†m c√¥ng vi·ªác l·∫•y v25 ƒë·ªÉ l√†m 1 tham s·ªë cho vi·ªác t√≠nh to√°n n√†o ƒë√≥, sau ƒë√≥ fill v√†o v24 ƒë·ªÉ n√≥ ch·ª©a flag. T·∫•t nhi√™n ch√∫ng ta s·∫Ω kh√¥ng ƒëi s√¢u v√†o c·ª• th·ªÉ n√≥ l√†m g√¨ v√¨ r·∫•t kh√™.

- ƒê·∫øn h√†m nh·∫≠p input cho v23, th√¨ m√¨nh th·∫•y n√≥ struct gi·ªëng v·ªõi v24, n√™n sau 1 h·ªìi t√¨m hi·ªÉu th√¨ k·∫øt lu·∫≠n v23 v√† v24 l√† std::wstring v·ªõi struct nh∆∞ sau : 
```c
struct wstring_like
{
    void*   _Mgr;        // +0x00 : metadata / allocator / manager
    wchar_t* _Data;      // +0x04 : con tr·ªè t·ªõi buffer wchar_t 
    uint32_t _Size;      // +0x08 : s·ªë k√Ω t·ª± (kh√¥ng t√≠nh null)
    uint32_t _Capacity; // +0x0C : capacity
    // ph·∫ßn c√≤n l·∫°i: padding / debug / flags / alignment
};
```

    
- ti·∫øp t·ª•c ƒë·∫øn h√†m cu·ªëi c·∫ßn xem x√©t l√† `sub_281040((int)v24, (int)v23)`
    
```c
bool __cdecl sub_281040(int a1, int a2)
{
  int v2; // esi
  int v4; // esi
  unsigned int i; // [esp+D4h] [ebp-14h]
  int v6; // [esp+E0h] [ebp-8h]

  sub_271B27(&byte_29310F);
  v2 = sub_271447(a1);
  if ( v2 != sub_271447(a2) )
    return 0;
  v6 = 0;
  for ( i = 0; i < sub_271447(a1); ++i )
  {
    v4 = *(unsigned __int16 *)sub_271677(i);
    v6 |= *(unsigned __int16 *)sub_271677(i) ^ v4;
  }
  return v6 == 0;
}
```
Trace h√†m `sub_271447` th√¨ t√¥i th·∫•y n√≥ tr·∫£ v·ªÅ gi√° tr·ªã b·∫±ng v·ªõi c·∫£ ƒë·ªô d√†i c·ªßa strings n√™n c√≥ th·ªÉ rename n√≥ l√† .size() c≈©ng ƒë∆∞·ª£c. V√† h√†m `sub_271677` tr·∫£ v·ªÅ cho ta gi√° tr·ªã c·ªßa k√≠ t·ª±. Ok gi·ªù c√≥ th·ªÉ vi·∫øt l·∫°i h√†m th√†nh nh∆∞ n√†y 
```c
bool sosanh(const std::wstring& a, const std::wstring& b)
{
    if (a.size() != b.size())
        return false;    // tho√°t s·ªõm n·∫øu size() kh√°c nhau

    unsigned int diff = 0;
    for (size_t i = 0; i < a.size(); ++i)
    {
        diff |= (unsigned int)(a[i] ^ b[i]); 
    }// xor t·ª´ng k√≠ t·ª± c·ªßa 2 string, r·ªìi or d·ªìn v√†o diff ƒë·ªÉ check kh√°c nhau 
    return diff == 0;
}
```

- Ok v·∫≠y l√† ch√∫ng ta ƒë√£ ph√¢n t√≠ch h·∫ßu h·∫øt c√°c h√†m quan tr·ªçng trong ch∆∞∆°ng tr√¨nh r·ªìi. C√°c h√†m c√≤n l·∫°i kh√¥ng c·∫ßn qu√° quan t√¢m l·∫Øm. 1 b√†i r·∫•t hay
    
<details>
<summary><b>FLAG üö©</b> </summary> 
DH{9cee017d454391a097fb55cc4dd4eee7}
</details>